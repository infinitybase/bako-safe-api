export DOCKER_API_VERSION ?= 1.44
NETWORK_NAME ?= bako-network

.PHONY: build socket-init socket-down socket-wait ensure-network

build:
	pnpm install
	pnpm run build

ensure-network:
	@echo "ðŸ”§ Checking Docker network '$(NETWORK_NAME)'..."; \
	if ! docker network ls --format '{{.Name}}' | grep -q "^$(NETWORK_NAME)$$"; then \
		docker network create $(NETWORK_NAME) >/dev/null; \
		echo "âœ… Network '$(NETWORK_NAME)' created."; \
	else \
		echo "âœ… Network '$(NETWORK_NAME)' already exists."; \
	fi

socket-init: ensure-network
	@echo "ðŸš€ Building and starting Socket Server..."; \
	docker compose -f docker-compose.yml up --build -d

socket-down:
	@echo "ðŸ§¹ Stopping Socket Server..."; \
	docker compose -f docker-compose.yml down

socket-wait:
	@echo "â³ Waiting for bako-socket-server to be healthy..."; \
	until [ "$$(docker inspect -f '{{.State.Health.Status}}' bako-socket-server 2>/dev/null)" = "healthy" ]; do \
		sleep 2; \
		echo "Still waiting for bako-socket-server..."; \
	done; \
	echo "âœ… bako-socket-server is healthy."
